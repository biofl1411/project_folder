name: Python 테스트

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v4

    - name: Python 설정
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 시스템 의존성 설치 (PyQt5용)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libegl1 \
          libxkbcommon0 \
          libdbus-1-3 \
          xvfb

    - name: Python 패키지 설치
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8

    - name: 문법 검사 (Flake8)
      run: |
        # 심각한 오류만 검사 (E9: 런타임 오류, F63: 테스트 오류, F7: 문법 오류, F82: 정의되지 않은 이름)
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

    - name: Import 테스트
      run: |
        xvfb-run python -c "
        import sys
        print('Python 버전:', sys.version)

        # 모든 모듈 import 테스트
        print('모듈 import 테스트 시작...')

        try:
            import database
            print('✓ database 모듈 OK')
        except Exception as e:
            print(f'✗ database 모듈 오류: {e}')
            sys.exit(1)

        try:
            from models import items, clients, fees, product_types
            print('✓ models 모듈 OK')
        except Exception as e:
            print(f'✗ models 모듈 오류: {e}')
            sys.exit(1)

        try:
            from views import MainWindow
            print('✓ views 모듈 OK')
        except Exception as e:
            print(f'✗ views 모듈 오류: {e}')
            sys.exit(1)

        print('모든 import 테스트 통과!')
        "

    - name: 단위 테스트 실행
      run: |
        if [ -d "tests" ]; then
          xvfb-run pytest tests/ -v
        else
          echo "tests/ 폴더가 없습니다. 테스트 파일을 추가하면 자동으로 실행됩니다."
        fi
